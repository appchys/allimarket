<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra | Tienda</title>
    <link rel="stylesheet" href="./css/checkout.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Incluir Toastify CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div class="checkout-container">
        <header class="checkout-header">
            <a href="javascript:history.back()" class="back-link" style="font-size: 1rem; color: #374151; text-decoration: none; display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <i class="bi bi-arrow-left"></i> Volver atrás
            </a>
            <h1><i class="bi bi-bag-check"></i> Finalizar Compra</h1>
        </header>

        <main class="checkout-main">
            <!-- Información del Cliente (mover arriba del resumen del pedido) -->
            <section class="checkout-section customer-info">
                <h2><i class="bi bi-person"></i> Información</h2>
                <div id="user-info-container"></div>
                <div class="google-login-section">
                    <!-- Quita el onclick del botón -->
                    <button class="btn btn-google" id="google-login-btn">
                        <i class="bi bi-google"></i> Iniciar sesión con Google
                    </button>
                </div>
            </section>

            <!-- Resumen del Pedido (debe ir después de Información) -->
            <section class="checkout-section cart-summary">
                <h2><i class="bi bi-cart3"></i> Resumen del Pedido</h2>
                <div id="cart-details" class="cart-items">
                    <!-- Productos cargados dinámicamente -->
                </div>
                <div class="order-total">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Envío:</span>
                        <span id="shipping">$0.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>
            </section>

            <!-- Tipo de entrega -->
            <section class="checkout-section delivery-type">
                <h2><i class="bi bi-shop-window"></i> ¿Cómo deseas recibir tu pedido?</h2>
                <div class="delivery-type-options">
                    <label class="delivery-type-option">
                        <input type="radio" name="deliveryType" value="delivery" checked>
                        <div class="option-content">
                            <i class="bi bi-truck"></i>
                            <span>Delivery a domicilio</span>
                        </div>
                    </label>
                    <label class="delivery-type-option">
                        <input type="radio" name="deliveryType" value="pickup">
                        <div class="option-content">
                            <i class="bi bi-shop"></i>
                            <span>Retiro en tienda</span>
                        </div>
                    </label>
                </div>
            </section>

            <!-- Dirección de Entrega (oculta por defecto) -->
            <section class="checkout-section delivery-address hidden">
                <h2><i class="bi bi-geo-alt"></i> Dirección de Entrega</h2>
                <div id="saved-addresses" class="address-list"></div>
                <button id="add-address-btn" class="btn secondary">
                    <i class="bi bi-plus-circle"></i> Agregar Dirección
                </button>
                <div id="new-address-form" class="address-form hidden">
                    <h3><i class="bi bi-pencil-square"></i> Nueva Dirección</h3>
                    <form id="addressForm">
                        <div class="form-group">
                            <label for="reference">Referencia (Ej: Casa, Oficina)</label>
                            <input type="text" id="reference" name="reference" placeholder="Ej: Frente al parque" required>
                        </div>
                        <button type="button" id="get-location-btn" class="btn secondary">
                            <i class="bi bi-geo-alt-fill"></i> Usar mi ubicación actual
                        </button>
                        <!-- Coordenadas ocultas para registro interno -->
                        <input type="hidden" id="latitude" name="latitude" value="0.0000">
                        <input type="hidden" id="longitude" name="longitude" value="0.0000">
                        <!-- El mapa inicia oculto -->
                        <div id="map" style="width: 100%; height: 300px; margin: 16px 0; border-radius: 8px; overflow: hidden; display: none;"></div>
                        <button type="submit" class="btn primary">
                            <i class="bi bi-save2"></i> Guardar Dirección
                        </button>
                    </form>
                </div>
            </section>

            <!-- Nueva sección: Tiempo de entrega -->
            <section class="checkout-section delivery-time">
                <h2><i class="bi bi-clock"></i> ¿Cuándo deseas tu pedido?</h2>
                <div class="delivery-time-options">
                    <label class="delivery-time-option">
                        <input type="radio" name="deliveryTime" value="asap" checked>
                        <div class="option-content">
                            <i class="bi bi-lightning-charge"></i>
                            <span>Entrega inmediata</span>
                            <!-- El texto de tiempo se insertará dinámicamente aquí -->
                        </div>
                    </label>
                    <label class="delivery-time-option">
                        <input type="radio" name="deliveryTime" value="scheduled">
                        <div class="option-content">
                            <i class="bi bi-calendar-event"></i>
                            <span>Programar entrega</span>
                        </div>
                    </label>
                </div>
                <div id="scheduled-delivery-fields" class="scheduled-fields hidden" style="margin-top: 1rem;">
                    <div class="form-group">
                        <label for="scheduled-date">Día</label>
                        <input type="date" id="scheduled-date" name="scheduled-date" min="">
                    </div>
                    <div class="form-group">
                        <label for="scheduled-time">Hora</label>
                        <input type="time" id="scheduled-time" name="scheduled-time">
                    </div>
                </div>
            </section>

            <!-- Método de Pago -->
            <section class="checkout-section payment-method">
                <h2><i class="bi bi-credit-card"></i> Método de Pago</h2>
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" name="payment" value="Efectivo" checked>
                        <div class="option-content">
                            <i class="bi bi-cash-coin"></i>
                            <span>Efectivo</span>
                        </div>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="Transferencia">
                        <div class="option-content">
                            <i class="bi bi-bank"></i>
                            <span>Transferencia</span>
                        </div>
                    </label>
                </div>
                <div id="bank-details" class="bank-info hidden">
                    <h3><i class="bi bi-building"></i> Datos Bancarios</h3>
                    <div id="bank-accounts-list" class="accounts-list"></div>
                </div>
            </section>

            <!-- Confirmación -->
            <section class="checkout-confirm">
                <button id="confirm-btn" class="btn confirm-btn">
                    <i class="bi bi-check-circle-fill"></i> Confirmar Pedido
                </button>
                <p class="secure-checkout">
                    <i class="bi bi-lock-fill"></i> Compra segura - Tus datos están protegidos
                </p>
            </section>
        </main>
    </div>
    <!-- Incluir Toastify JS -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module" src="./js/checkout.js"></script>

    <!-- Modal de zonas de cobertura -->
    <div id="coverageZonesModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;">
      <div style="background:#fff;padding:24px 20px;border-radius:10px;max-width:400px;width:95vw;box-shadow:0 2px 16px #0002;position:relative;">
        <button id="closeCoverageZonesModal" style="position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;">&times;</button>
        <h3 style="margin-bottom:12px;font-size:1.1em;">Zonas de cobertura de la tienda</h3>
        <div id="coverageZonesMap" style="width:100%;height:300px;border-radius:8px;"></div>
        <div id="coverageZonesList" style="margin-top:10px;font-size:0.98em;"></div>
      </div>
    </div>
</body>
</html>